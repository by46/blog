---
title: "Cache"
date: 2017-12-28T22:36:16+08:00
draft: true
---

# Cache

今天来说说HTTP Cache， 它让人又爱又恨，爱的是它能优化你的网站， 恨的是会带来莫名其妙的问题。

重用已经获得的资源能够有效的提升网站和应用的性。HTTP缓存能缓解网络延迟和网络阻塞。

HTTP缓存是一种保存资源副本并且在下次请求时直接使用的技术，当HTTP缓存发现请求的资源已经被存储，它拦截该请求，并直接返回资源的副本，而不会去请求服务器重新请求资源，从而可以节省宝贵的时间，和减轻服务器压力。这样的直接好处就是：减轻服务器压力，减少网络延时，提升性能。同时，有一点非常重要，如果资源发生变化，资源的副本不应该在用于响应请求，应该立即失效。

缓存主要分为两类：共有缓存和私有缓存。共有缓存能够被多用户共同使用，而私有缓存只能为特定用户服务。例如本文介绍的代理缓存和浏览器缓存就是这样的代表， 还有一些常见的缓存，例如：网关缓存、CDN

## 浏览器缓存（私有）
浏览器缓存就是典型的私有缓存，它只能服务某个特定的用户。浏览器缓存拥有所有通过HTTP请求的资源的副本，这些缓存用于浏览器向前、向后、保存网页和查看源码等功能，有浏览器缓存就可以避免再次请求服务器资源。

## 代理缓存（共有）
例如：CDN，它可以缓存一些热门的资源，就可以重用这些资源，为多人提供服务，就能减少网络阻塞。

## 缓存控制
HTTP／1.1定义的`Cache-Control`用来支持缓存，请求头和响应头痘支持这个属性，通过这个属性，可以控制缓存策略。

### 禁止缓存
不缓存如何客户端请求和服务端响应。

```
Cache-Control: no-store
Cache-Control: no-cache, no-store, must-revalidate
```

### 强制缓存确认
如下设置请求头，客户端每次发送请求是， 缓存都会把请求发送到服务器（请求可能回携带if-modified-since，if-none-match等HTTP头部），服务器会验证请求描述的缓存是否过期， 如果没有过期，就反悔304的状态，缓存就可以使用本地缓存副本。

```
Cache-Control: no-cache
```

### 公共缓存和私有缓存

`public`指令表示该响应可以背任何中间人（例如缓存代理， CDN等）
`private`指令表示该响应只能用于特定用户的私有缓存， 例如浏览器私有缓存

```
Cache-Control: public
Cache-Control: private
```

### 缓存过期机制

过期机制中， `max-age=<seconds>`最为重要，它表示资源能够被缓存（保持新鲜）的最大时间。

```
Cache-Control: max-age=300
```

### 缓存验证确认
当使用了`must-revalidate`,就表示缓存在考虑一个陈旧的资源时，必须验证它的新鲜度，已过期的缓存将不能被使用。

```
Cache-Control: must-revalidate
```

### Pragma 请求头

`Pragma` 是HTTP/1.0的请求头， 他不能用于HTTP Response。
虽然它的行为和HTTP/1.1中设置`Cache-Control: no-cache`，或则缺失`Cache-Control`才不多,
也不能100%由HTTP/1.1的`Cache-Control: no-cache`请求替换。 
它仅能用于兼容HTTP/1.0的客户端。

## 新鲜度
理论上， 一旦某个资源被存入缓存中，它就应该能永远可用。 但是，缓存的容量是有限， 所以不得不定期删除缓存中的资源， 
释放存储空间，这个过程被称为“缓存驱逐（Cache Eviction）”。另一方面， 如果服务器上某个资源发生了变化， 缓存也应该
被相应地更新。由于HTTP是一个Client-Server 协议， 所以资源发生变化， 服务器没有办法通知缓存和客服端。所以缓存和
客服端不得不定期与服务器通行，来确定资源是否发生变化。这个不定期的间隔曾为过期时间， 在过期以前， 就假定资源
一定是新鲜的， 反之，资源就变得不新鲜， 不可用。

如果Cache通过携带`If-None-Match`请求头到服务端验证资源的新鲜度，并且服务端返回304（Not Modified）的状态码，
就表明， 过期资源依然新鲜。

服务端可以通过`Cache-Control`来控制资源的过期时间。例如： `Cache-Control: max-age=N` 表示该资源N秒以内都是新鲜的， 
可以大胆使用。也同通过`Expires`来设置资源在某个时间之前都是新鲜， 区别是它设置的时间点， 而不是过期秒数。

### 服务器在验证

已过期的缓存文档，并不等同于该资源彻底不可用，所以我需要一种机制来检查缓存的资源是否真的不可用，
所以这种机制称为“服务器再验证”

所以HTTP提供了5个常用的条件请求首部，来支持“服务器再验证”机制，所有条件首部都是以“If-”为前缀， 
其中最常用的两个是： `If-Modified-Since` 和 `If-None-Match`：

#### If-Modified-Since
表示如果从自定日期之后文档被修改过， 就执行请求的方法，需要同`Last-Modified`配合使用；否则返回304 状态码

#### If-None-Match
服务器可以为资源打上标签（ETag）来唯一标识资源， 这样就可以通过`If-None-Match`首部来确定该资源在服务器上
是否发生改变。